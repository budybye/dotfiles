name: Run Test install dotfiles
on:
  push:
    branches:
    - main
jobs:
  ubuntu-amd64:
    runs-on: ubuntu-24.04
    env:
      MISE_GITHUB_TOKEN: ${{ secrets.MISE_GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - name: make
        run: make init

  ubuntu-arm64:
    runs-on: ubuntu-24.04-arm
    env:
      MISE_GITHUB_TOKEN: ${{ secrets.MISE_GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - name: make
        run: make init

  darwin:
    runs-on: macos-15
    env:
      MISE_GITHUB_TOKEN: ${{ secrets.MISE_GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - name: make
        run: make init

  powershell:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: MinoruSekine/setup-scoop@v4.0.1
        with:
          buckets: extras
          apps: curl make git

  windows-11-arm64:
    runs-on: windows-11-arm
    steps:
      - uses: actions/checkout@v4
      # - name: winget
      #   run: winget install Microsoft.PowerToys

  wsl2:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4
      - uses: Vampire/setup-wsl@v6
      - run: apt update && apt upgrade -y
      - shell: wsl-bash {0}
        run: |
          ls -al

  lxd:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Incus
        uses: bdx0/action-incus@v1

      - name: Launch instance
        run: |
          lxc profile create dev && \
          cat cloud-init/lxd.yaml | lxc profile edit dev
          lxc launch ubuntu:24.04 ubuntu -p default -p dev
          lxc exec ubuntu -- cloud-init status --wait || true
          lxc exec ubuntu -- tail -8 /var/log/cloud-init.log
          lxc exec ubuntu -- cat /home/budybye/.ssh/authorized_keys
          lxc exec ubuntu -- ls -la /home/budybye/dotfiles
          lxc exec ubuntu -- echo "$SHELL"
          lxc exec ubuntu -- cat /etc/os-release

  rpi:
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4
      - name: Setup LXD
        uses: canonical/setup-lxd@main
        with:
          channel: latest/edge
      - name: Launch container
        run: |
          lxc launch ubuntu:24.04 rpi --config=user.user-data="$(cat cloud-init/user-data)"
          lxc exec rpi -- cloud-init status --wait || true
          lxc exec rpi -- tail -8 /var/log/cloud-init.log
          lxc exec rpi -- cat /etc/os-release && env
