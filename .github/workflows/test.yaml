name: Test

on:
  push:
    branches:
      - main

jobs:

  ubuntu-test:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: make
        run: make init

  mac-test:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
      - name: make
        run: make init

  windows-test:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4
      - uses: Vampire/setup-wsl@v3
        with:
          distribution: Ubuntu-24.04

      - shell: wsl-bash {0}
        run: |
          ls -la
          uname -a

  cloud-init:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Setup LXD
        uses: canonical/setup-lxd@main
        with:
          channel: latest/edge

      - name: Launch container
        run: |
          lxc profile create bob && cat cloud-init/lxd.yaml | lxc profile edit bob
          lxc launch ubuntu:24.04 ubuntu -p default -p bob
          lxc exec ubuntu -- cloud-init status --wait || true
          lxc exec ubuntu -- tail -4 /var/log/cloud-init.log
          lxc exec ubuntu -- cat /home/ubuntu/.ssh/authorized_keys
          lxc exec ubuntu -- ls -la /home/ubuntu/dotfiles
          lxc exec ubuntu -- echo "$SHELL"
          lxc exec ubuntu -- uname -a
          # lxc launch ubuntu:24.04 ubuntu --config=user.user-data="$(cat cloud-init/multipass.yaml)"
