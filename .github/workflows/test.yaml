name: Test

on:
  push:
    branches: ["main"]
    tags:
      - "v*.*.*"
  workflow_dispatch:

env:
  IMAGE_NAME: ubuntu-xrdp

jobs:

  docker-build-push-compose:
    runs-on: ubuntu-24.04
    # strategy:
    #   matrix:
    #     platforms: [linux/amd64, linux/arm64]
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/${{ env.IMAGE_NAME }}
      - uses: docker/setup-buildx-action@v3
      - uses: docker/setup-qemu-action@v3
      - uses: docker/build-push-action@v5
        with:
          context: .
          file: .devcontainer/Dockerfile
          # platforms: ${{ matrix.platforms }}
          push: true
          tags: ghcr.io/${{ github.repository }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}
      - name: docker compose test
        run: |
          cd .devcontainer
          docker compose up -d
          docker logs ipfs
          docker ps -a
          docker compose down
      - uses: anderssonPeter/cloud-init-linter@v1
        with:
          files:
            ./cloud-init/multipass.yaml

  ubuntu-test:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: make
        run: make sense

  mac-test:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
      - name: make
        run: make sense

  windows-test:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4
      - uses: Vampire/setup-wsl@v3
        with:
          wsl-shell-command: bash --noprofile --norc -euo pipefail
          distribution: Ubuntu-24.04

      - shell: wsl-bash {0}
        run: |
          ls -la
          uname -a
          sudo apt update && sudo apt upgrade -y
          sudo apt install -y cmake git curl gzip zsh
          curl -fsSL https://get.chezmoi.io | sh -s -- init --apply -S .
          make sense
