#! /usr/bin/env bash

USER_NAME=$(whoami)
SSH="${HOME}/.ssh"
KEY_TYPE="ed25519"
KEY_NAME="id_${KEY_TYPE}_${USER_NAME}"
KEY_PATH="${SSH}/${KEY_NAME}"
# SSH用のディレクトリを作成
mkdir -p "${SSH}"
# authorized_keysとconfigファイルを作成
sudo chmod 700 "${SSH}"
touch "${SSH}/authorized_keys"

# configファイルにGitHubのホスト情報を設定
cat <<EOF >>"${SSH}/config"
Host github github.com
HostName github.com
IdentityFile "${KEY_PATH}"
User git
EOF

ls -la "${SSH}"

cd "${SSH}"

if [ -f "${KEY_PATH}.pub" ]; then
    sudo cp "${KEY_PATH}.pub" "${KEY_PATH}.pub.copy"
    rm -rf "${KEY_PATH}.pub"
fi

# SSH鍵を生成
if [ ! -f "${KEY_PATH}" ]; then
    ssh-keygen -t "${KEY_TYPE}" -f "${KEY_NAME}" -C "${USER_NAME}" -N ""
else
    echo "SSH key already exists"
    sudo cp "${KEY_PATH}" "${KEY_PATH}.copy"
    rm -rf "${KEY_PATH}"
    ssh-keygen -t "${KEY_TYPE}" -f "${KEY_NAME}" -C "${USER_NAME}" -N ""
fi

# 公開鍵をauthorized_keysファイルに追加
cat "${KEY_PATH}.pub" >>"${SSH}/authorized_keys"

# 公開鍵をコピー
# ブラウザでgithubログイン画面を開く

{{/*

{{ if eq .chezmoi.os "darwin" -}}
    pbcopy <"${KEY_PATH}.pub"
    open "https://github.com/settings/keys"
{{ else if eq .chezmoi.os "linux" -}}
    if command -v xsel >/dev/null 2>&1; then
        xsel --clipboard --input <"${KEY_PATH}.pub"
    else
        cat "${KEY_PATH}.pub"
    fi
    xdg-open "https://github.com/settings/keys"
{{ end }}

*/}}

chmod 600 "${KEY_PATH}"
chmod 600 "${SSH}/authorized_keys"
chmod 644 "${KEY_PATH}.pub"

# GitHubにSSH接続をテスト

# ssh -T git@github.com

# SSHエージェントを起動
eval "$(ssh-agent)"
# SSH鍵をエージェントに登録
ssh-add "${KEY_PATH}"
# 登録したSSH鍵の一覧を表示
ssh-add -l
# SSHエージェントを停止
eval "$(ssh-agent -k)"

echo "--------------------------------"
cd "${HOME}"
echo "${KEY_PATH} done"

ls -la "${SSH}"
cat "${SSH}/config"
cat "${SSH}/authorized_keys"
