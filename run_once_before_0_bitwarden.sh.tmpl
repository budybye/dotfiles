#! /usr/bin/env bash

echo "OS: {{ .chezmoi.os | quote }}"
echo "before bitwarden cli install"
cd ${HOME}

{{ if eq .chezmoi.os "darwin" -}}
    brew install bitwarden-cli node@20 || echo "bitwarden cli install failed."

{{ else if eq .chezmoi.os "linux" -}}
    curl https://mise.run | sh && export PATH="${HOME}/.local/bin:${PATH}"

    if command -v mise >/dev/null 2>&1; then
        mise use -g bitwarden node@20 -y && mise activate bash

    elif command -v ${HOME}/.local/bin/mise >/dev/null 2>&1; then
        ${HOME}/.local/bin/mise use -g bitwarden node@20 -y && ${HOME}/.local/bin/mise activate bash

    elif command -v cargo >/dev/null 2>&1; then
        cargo install mise && ${HOME}/.cargo/bin/mise use -g bitwarden node@20 -y && ${HOME}/.cargo/bin/mise activate bash

    else
        sudo apt-get install -y cargo && cargo install mise && ${HOME}/.cargo/bin/mise use -g bitwarden node@20 -y && ${HOME}/.cargo/bin/mise activate bash
    fi
{{ end -}}

if command -v bw >/dev/null 2>&1; then
    echo "export BW_SESSION="$(bw unlock --raw)"" >> .env || echo "bw unlock failed."
elif command -v ${HOME}/.local/share/mise/bitwarden/installs/2024.11.0/bin/bw >/dev/null 2>&1; then
    echo "export BW_SESSION="$(${HOME}/.local/share/mise/bitwarden/installs/2024.11.0/bin/bw unlock --raw)"" >> .env || echo "bw unlock failed."
else
    echo "bw install failed."
fi

echo "${PATH}" | tr ':' '\n'
echo "bitwarden cli install complete"
