#!/usr/bin/env bash
# chezmoi apply が完了したら実行される

echo "--------------------------------"
echo "Chezmoi apply completed!!"
pwd
ls -la
echo "File check start!!"
echo "--------------------------------"
echo "${HOME}"
ls -la "${HOME}"
echo "--------------------------------"
echo "${HOME}/.config"
ls -la "${HOME}/.config"
echo "--------------------------------"
echo "${HOME}/.local/bin"
ls -la "${HOME}/.local/bin"
echo "--------------------------------"
echo "${HOME}/.local/share"
ls -la "${HOME}/.local/share"
echo "--------------------------------"
# chezmoi のディレクトリが存在するか確認 actionsだと無い
if [ -d "${HOME}/.local/share/chezmoi" ]; then
    echo "${HOME}/.local/share/chezmoi"
    ls -la "${HOME}/.local/share/chezmoi"
else
    echo "${HOME}/.local/share/chezmoi not found"
fi
echo "--------------------------------"

echo 'Dotfiles link ...'
# .local/share/chezmoi ディレクトリが存在するか確認
if [ -d "${HOME}/.local/share/chezmoi" ]; then
    if [ ! -d "${HOME}/dotfiles" ]; then
        ln -sf "${HOME}/.local/share/chezmoi" "${HOME}/dotfiles" && ls -la "${HOME}/dotfiles" || echo 'Dotfiles link failed!!'
    else
        echo 'Dotfiles link already exists!!'
        ls -la "${HOME}/dotfiles"
    fi
    echo "--------------------------------"

    # .env ファイルが存在しない場合は作成
    if [ ! -f "${HOME}/.local/share/chezmoi/.env" ]; then
        echo "export USER_NAME=$(whoami)" >>"${HOME}/.local/share/chezmoi/.env"
        echo "export EMAIL=101wayout@gmail.com" >>"${HOME}/.local/share/chezmoi/.env"
        ls -la "${HOME}/.local/share/chezmoi"
    fi

else
    echo "${HOME}/.local/share/chezmoi not found"
fi

echo "--------------------------------"

echo 'Your config git user is ...'
cat "${HOME}/.config/git/user.conf"

echo "--------------------------------"

echo 'userconf update ? (y/n)'

{{ if eq .chezmoi.username "hotmilk" }}

read ans
if [ "$ans" = "y" ]; then
    git config --global user.name "${GIT_USER:-bob}"
    git config --global user.email "${GIT_EMAIL:-bob@example.com}"
fi

{{ end }}
echo "--------------------------------"
echo 'Change settings done!!'
